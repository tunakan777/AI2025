<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini RSS ニュース</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    // Lucide アイコンの代替（シンプルなSVG）
    const Newspaper = () => (
      <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
      </svg>
    );

    const Tag = () => (
      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
      </svg>
    );

    const Loader = () => (
      <svg className="w-12 h-12 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const AlertCircle = () => (
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const NewsAggregator = () => {
      const [selectedCategory, setSelectedCategory] = useState('technology');
      const [news, setNews] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const categories = {
        technology: { 
          name: 'テクノロジー', 
          rss: 'https://news.google.com/rss/search?q=technology+OR+AI+OR+software&hl=ja&gl=JP&ceid=JP:ja'
        },
        business: { 
          name: 'ビジネス', 
          rss: 'https://news.google.com/rss/search?q=business+OR+economy+OR+finance&hl=ja&gl=JP&ceid=JP:ja'
        },
        entertainment: { 
          name: 'エンターテインメント', 
          rss: 'https://news.google.com/rss/search?q=entertainment+OR+movie+OR+music&hl=ja&gl=JP&ceid=JP:ja'
        }
      };

      const parseRSS = (xmlText) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlText, 'text/xml');
        const items = doc.querySelectorAll('item');
        
        return Array.from(items).slice(0, 15).map((item, idx) => {
          return {
            id: idx,
            title: item.querySelector('title')?.textContent || '',
            link: item.querySelector('link')?.textContent || '',
            description: item.querySelector('description')?.textContent?.replace(/<[^>]*>/g, '') || '',
            pubDate: item.querySelector('pubDate')?.textContent || ''
          };
        });
      };

      const generateTags = async (newsItems) => {
        const newsWithTags = [];
        
        // ⚠️ ここにあなたのGemini APIキーを設定してください
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';
        
        for (const item of newsItems) {
          try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `以下のニュース記事のタイトルと説明から、適切な3つのタグ(キーワード)を日本語で生成してください。タグはカンマ区切りで出力し、それ以外は何も出力しないでください。

タイトル: ${item.title}
説明: ${item.description.substring(0, 200)}

出力例: AI, 技術革新, ビジネス`
                  }]
                }]
              })
            });

            const data = await response.json();
            const tagsText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const tags = tagsText.split(',').map(t => t.trim()).filter(t => t.length > 0).slice(0, 3);
            
            newsWithTags.push({
              ...item,
              tags: tags.length > 0 ? tags : ['ニュース']
            });
            
            await new Promise(resolve => setTimeout(resolve, 1000));
          } catch (err) {
            console.error('Tag generation error:', err);
            newsWithTags.push({
              ...item,
              tags: ['ニュース']
            });
          }
        }
        
        return newsWithTags;
      };

      const fetchNews = async (category) => {
        setLoading(true);
        setError(null);
        setNews([]);

        try {
          const rssUrl = categories[category].rss;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(rssUrl)}`;
          
          const response = await fetch(proxyUrl);
          if (!response.ok) {
            throw new Error('RSS取得に失敗しました');
          }
          
          const xmlText = await response.text();
          const parsedNews = parseRSS(xmlText);
          
          if (parsedNews.length === 0) {
            throw new Error('ニュースが見つかりませんでした');
          }

          const newsWithTags = await generateTags(parsedNews.slice(0, 10));
          setNews(newsWithTags);
          
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleCategoryChange = (category) => {
        setSelectedCategory(category);
        fetchNews(category);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="text-indigo-600">
                  <Newspaper />
                </div>
                <h1 className="text-3xl font-bold text-gray-800">
                  AI ニュースアグリゲーター
                </h1>
              </div>
              <p className="text-gray-600">
                Gemini APIを使用してリアルタイムニュースに自動タグ付け
              </p>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">
                カテゴリを選択
              </h2>
              <div className="flex gap-4 flex-wrap">
                {Object.entries(categories).map(([key, cat]) => {
                  return (
                    <button
                      key={key}
                      onClick={() => handleCategoryChange(key)}
                      className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                        selectedCategory === key
                          ? 'bg-indigo-600 text-white shadow-lg transform scale-105'
                          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      {cat.name}
                    </button>
                  );
                })}
              </div>
            </div>

            {loading && (
              <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                <div className="text-indigo-600 flex justify-center mb-4">
                  <Loader />
                </div>
                <p className="text-gray-600 text-lg">
                  ニュースを取得中... Gemini APIでタグを生成しています
                </p>
                <p className="text-gray-400 text-sm mt-2">
                  (この処理には数十秒かかります)
                </p>
              </div>
            )}

            {error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-6 flex items-start gap-3">
                <div className="text-red-600 flex-shrink-0 mt-1">
                  <AlertCircle />
                </div>
                <div>
                  <h3 className="text-red-800 font-semibold mb-1">エラー</h3>
                  <p className="text-red-700">{error}</p>
                </div>
              </div>
            )}

            {!loading && news.length > 0 && (
              <div className="space-y-4">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  {categories[selectedCategory].name} - 最新ニュース ({news.length}件)
                </h2>
                {news.map((item) => {
                  return (
                    <div
                      key={item.id}
                      className="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow p-6"
                    >
                      <h3 className="text-xl font-bold text-gray-800 mb-2 hover:text-indigo-600">
                        <a href={item.link} target="_blank" rel="noopener noreferrer">
                          {item.title}
                        </a>
                      </h3>
                      
                      <p className="text-gray-600 mb-3 line-clamp-2">
                        {item.description}
                      </p>
                      
                      <div className="flex items-center gap-2 mb-3">
                        <div className="text-indigo-600">
                          <Tag />
                        </div>
                        <div className="flex gap-2 flex-wrap">
                          {item.tags.map((tag, idx) => {
                            return (
                              <span
                                key={idx}
                                className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium"
                              >
                                {tag}
                              </span>
                            );
                          })}
                        </div>
                      </div>
                      
                      <p className="text-gray-400 text-sm">
                        {new Date(item.pubDate).toLocaleString('ja-JP')}
                      </p>
                    </div>
                  );
                })}
              </div>
            )}

            {!loading && !error && news.length === 0 && (
              <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                <div className="text-gray-300 flex justify-center mb-4">
                  <Newspaper />
                </div>
                <p className="text-gray-600 text-lg">
                  カテゴリを選択してニュースを表示
                </p>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<NewsAggregator />);
  </script>
</body>
</html>